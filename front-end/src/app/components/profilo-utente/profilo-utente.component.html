<div class="container min-vh-100 mb-5">
  <div
    class="d-flex justify-content-center text-primary align-items-center position-fixed top-50 start-50 z-3"
    *ngIf="caricamento"
  >
    <div class="spinner-border" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>
  <div>
    <div class="container py-5">
      <div class="row">
        <div class="col-lg-4">
          <div class="card mb-4 trasparenza">
            <button
              class="btn btn-primary text-success"
              (click)="apriModaleUpdate()"
            >
              Modifica dati personali
            </button>
            <div class="card-body text-center d-flex">
              <img
                *ngIf="user?.avatar"
                style="object-fit: cover; height: 200px; width: 200px"
                class="rounded-circle"
                alt="avatar1"
                [src]="user!.avatar"
              />
              <img
                *ngIf="!user?.avatar"
                style="object-fit: cover; height: 200px; width: 200px"
                class="rounded-circle"
                alt="avatar1"
                src="../../../assets/Profile-Avatar-PNG-Free-Download.png"
              />
            </div>
            <h5 class="my-3">{{ user?.username }}</h5>
          </div>
        </div>
        <div class="col-lg-8">
          <div class="card mb-4 trasparenza">
            <div class="card-body">
              <div class="row mb-3">
                <div class="col-sm-3">
                  <p class="fw-bold mb-0">Nome</p>
                </div>
                <div class="col-sm-9">
                  <p class="mb-0">{{ user!.nome | capitalizeFirst }}</p>
                </div>
              </div>
              <div class="row mb-3">
                <div class="col-sm-3">
                  <p class="fw-bold mb-0">Cognome</p>
                </div>
                <div class="col-sm-9">
                  <p class="mb-0">{{ user!.cognome | capitalizeFirst }}</p>
                </div>
              </div>
              <hr />
              <div class="row">
                <div class="col-sm-3">
                  <p class="fw-bold mb-0">Email</p>
                </div>
                <div class="col-sm-9">
                  <p class="mb-0">{{ user?.email }}</p>
                </div>
                <div class="col-sm-9">
                  <hr />
                  <div>
                    <h5 class="card-title">Statistiche partite passate</h5>
                    <p class="card-text">
                      Partite vinte: {{ conteggioPartiteVinte }}
                    </p>
                    <p class="card-text">
                      Partite perse: {{ conteggioPartitePerse }}
                    </p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Parte delle partite da giocare -->
  <div class="container text-start mt-3">
    <h2 class="text-primary">Partite da giocare</h2>
    <h4 *ngIf="partitePassate.length <= 0">
      Nessuna partita presente in questa sezione.
    </h4>
    <div class="row">
      <div *ngFor="let partita of partiteDaGiocare" class="mb-3 col-md-6">
        <div
          class="card bg-success rounded-6 p-1 p-md-2 d-flex shadow position-relative shadow-3-primary"
        >
          <div
            class="card-body p-2 text-start my-3 d-flex flex-column justify-content-center"
          >
            <div
              class="position-relative border-bottom d-flex justify-content-between align-items-center border-secondary pb-4 h-100"
            >
              <h5 class="card-title m-0">
                {{ formattaData(partita.dataPrenotazione) }}<br />
                {{ partita.slotOrario.inizio | slice : 0 : 5 }} -
                {{ partita.slotOrario.fine | slice : 0 : 5 }}
              </h5>
              <div
                class="vr bg-primary position-absolute start-50"
                style="top: -15px; height: 100%; width: 2px"
              ></div>
              <div class="d-flex flex-column justify-content-center gap-1">
                <h5 class="card-subtitle text-primary">
                  {{ partita.slotOrario.campo.nomeCampo }}
                </h5>
                <span
                  [ngClass]="{
                    'bg-secondary':
                      partita.numGiocatoriAttuali < partita.numMaxGiocatori,
                    'bg-primary':
                      partita.numGiocatoriAttuali == partita.numMaxGiocatori,
                    
                  }"
                  class="badge rounded-pill text-success rounded-pill d-block"
                  style="width: 130px"
                  >{{
                    partita.numGiocatoriAttuali === partita.numMaxGiocatori
                      ? "Partita completa"
                      : "Partita incompleta"
                  }}</span
                >
              </div>
            </div>
            <div class="d-flex justify-content-center mt-4 mb-2">
              <div
                *ngFor="let i of [0, 1, 2, 3]; let j = index"
                class="avatar-wrapper"
              >
                <ng-container
                  *ngIf="
                    j < partita.utentiPrenotati.length;
                    else placeholderAvatar
                  "
                >
                  <button
                    class="btn btn-primary rounded-circle position-relative btn-floating shadow-0"
                    style="width: 50px; height: 50px; border: none"
                    [ngClass]="{
                      'border border-primary border-2':
                        partita.utentiPrenotati[j].id === this.user!.id
                    }"
                  >
                    <img
                      [src]="
                        partita.utentiPrenotati[j].avatar
                          ? partita.utentiPrenotati[j].avatar
                          : '../../../assets/Profile-Avatar-PNG-Free-Download.png'
                      "
                      alt="{{ partita.utentiPrenotati[j].nome }}"
                      class="w-100 h-100 rounded-circle img-fluid"
                      style="object-fit: cover"
                    />
                  </button>
                  <div class="mt-2 text-center avatar-text nome h6">
                    <span
                      class="d-block d-md-inline"
                      title="{{
                        partita.utentiPrenotati[j].nome
                          .charAt(0)
                          .toUpperCase() +
                          partita.utentiPrenotati[j].nome.slice(1) +
                          ' ' +
                          partita.utentiPrenotati[j].cognome
                            .charAt(0)
                            .toUpperCase() +
                          partita.utentiPrenotati[j].cognome
                            .slice(1)
                            .toLowerCase()
                      }}"
                    >
                      {{
                        partita.utentiPrenotati[j].nome.charAt(0).toUpperCase()
                      }}.
                    </span>
                    <span class="d-inline">
                      {{
                        partita.utentiPrenotati[j].cognome
                          .charAt(0)
                          .toUpperCase() +
                          partita.utentiPrenotati[j].cognome
                            .slice(1)
                            .toLowerCase()
                      }}
                    </span>
                  </div>
                </ng-container>
                <ng-template #placeholderAvatar>
                  <button
                    [ngClass]="{
                      'btn-dark': verificaUtenteGiaAggiunto(partita),
                      disabled: verificaUtenteGiaAggiunto(partita)
                    }"
                    class="btn btn-success rounded-circle position-relative btn-floating shadow-0"
                    style="width: 50px; height: 50px"
                  >
                    <img
                      src="https://upload.wikimedia.org/wikipedia/commons/archive/3/36/20120517134445%21Tennis_ball_3.svg"
                      alt="Placeholder Avatar"
                      class="w-100 h-100 rounded-circle img-fluid"
                      style="object-fit: cover"
                    />
                  </button>
                  <div
                    class="mt-2 text-center text-secondary avatar-text nome h6"
                  >
                    {{
                      partita.numGiocatoriAttuali === partita.numMaxGiocatori
                        ? "Bloccato"
                        : "Mancante"
                    }}
                  </div>
                </ng-template>
              </div>
            </div>
            <div class="d-flex justify-content-center gap-1 gap-md-3 mt-3">
              <button
                style="width: 220px"
                *ngIf="
                  verificaPiu24H(
                    partita.dataPrenotazione,
                    partita.slotOrario.inizio
                  ) || user!.ruolo == 'ADMIN'
                "
                class="btn btn-secondary btn-sm text-primary shadow-none custom-button"
                (click)="apriModale(partita.id!)"
              >
                Annulla
              </button>

              <button
                style="width: 220px"
                class="btn btn-sm custom-button"
                [ngClass]="{
                  'btn-secondary  shadow-none text-success':
                    partita.numGiocatoriAttuali < partita.numMaxGiocatori,
                  'btn-primary shadow-none text-success':
                    partita.numGiocatoriAttuali === partita.numMaxGiocatori
                }"
                (click)="bloccaESbloccaPartecipazione(partita)"
              >
                {{
                  partita.numGiocatoriAttuali === partita.numMaxGiocatori
                    ? "Sblocca prenotazioni"
                    : "Blocca prenotazioni"
                }}
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Parte delle partite passate -->

  <div class="container text-start mt-3">
    <h2 class="text-primary">Partite passate</h2>
    <h4 *ngIf="partitePassate.length <= 0">
      Nessuna partita presente in questa sezione.
    </h4>
    <div class="row">
      <div *ngFor="let partita of partitePassate" class="mb-3 col-md-6">
        <div
          class="card bg-success rounded-5 p-1 d-flex shadow position-relative"
        >
          <div
            class="card-body p-2 text-start my-3 d-flex flex-column justify-content-center"
          >
            <div
              class="position-relative border-bottom d-flex justify-content-between align-items-center border-secondary pb-4 h-100"
            >
              <h5 class="card-title m-0">
                {{ formattaData(partita.dataPrenotazione) }}<br />
                {{ partita.slotOrario.inizio | slice : 0 : 5 }} -
                {{ partita.slotOrario.fine | slice : 0 : 5 }}
              </h5>
              <div
                class="vr bg-primary position-absolute start-50"
                style="top: -15px; height: 100%; width: 2px"
              ></div>
              <div class="d-flex flex-column justify-content-center gap-1">
                <h5 class="card-subtitle text-primary">
                  {{ partita.slotOrario.campo.nomeCampo }}
                </h5>
                <span
                  *ngIf="
                    partita.numGiocatoriAttuali === partita.numMaxGiocatori &&
                    partita.giocatoriVincenti.length < 2
                  "
                  [ngClass]="{
                    'bg-secondary':
                      partita.numGiocatoriAttuali < partita.numMaxGiocatori,
                    'bg-primary':
                      partita.numGiocatoriAttuali == partita.numMaxGiocatori,
                    
                  }"
                  class="badge rounded-pill text-success rounded-pill d-block"
                  style="width: 130px"
                  >{{
                    partita.numGiocatoriAttuali === partita.numMaxGiocatori
                      ? "Partita completa"
                      : "Partita incompleta"
                  }}</span
                >
                <span
                  *ngIf="partita.giocatoriVincenti.length == 2"
                  [ngClass]="{
                    'bg-secondary':
                      !utenteHaVinto(partita),
                    'bg-primary':
                     utenteHaVinto(partita),
                    
                  }"
                  class="badge rounded-pill text-success rounded-pill d-block"
                  style="width: 130px"
                  >{{ utenteHaVinto(partita) ? "Vinta" : "Persa" }}</span
                >
              </div>
            </div>
            <div class="d-flex justify-content-center mt-4 mb-2">
              <div
                *ngFor="let i of [0, 1, 2, 3]; let j = index"
                class="avatar-wrapper"
              >
                <ng-container
                  *ngIf="
                    j < partita.utentiPrenotati.length;
                    else placeholderAvatar
                  "
                >
                  <button
                    [ngClass]="{
                      'border border-primary border-3':
                        partita.utentiPrenotati[j].id === this.user!.id
                    }"
                    class="btn btn-primary rounded-circle position-relative btn-floating disabled shadow-0"
                    style="width: 50px; height: 50px; border: none"
                  >
                    <img
                      [src]="
                        partita.utentiPrenotati[j].avatar
                          ? partita.utentiPrenotati[j].avatar
                          : '../../../assets/Profile-Avatar-PNG-Free-Download.png'
                      "
                      alt="{{ partita.utentiPrenotati[j].nome }}"
                      class="w-100 h-100 rounded-circle img-fluid"
                      style="object-fit: cover"
                    />
                  </button>
                  <div class="mt-2 text-center avatar-text nome h6">
                    <span
                      class="d-block d-md-inline"
                      title="{{
                        partita.utentiPrenotati[j].nome
                          .charAt(0)
                          .toUpperCase() +
                          partita.utentiPrenotati[j].nome.slice(1) +
                          ' ' +
                          partita.utentiPrenotati[j].cognome
                            .charAt(0)
                            .toUpperCase() +
                          partita.utentiPrenotati[j].cognome
                            .slice(1)
                            .toLowerCase()
                      }}"
                    >
                      {{
                        partita.utentiPrenotati[j].nome.charAt(0).toUpperCase()
                      }}.
                    </span>
                    <span class="d-inline">
                      {{
                        partita.utentiPrenotati[j].cognome
                          .charAt(0)
                          .toUpperCase() +
                          partita.utentiPrenotati[j].cognome
                            .slice(1)
                            .toLowerCase()
                      }}
                    </span>
                  </div>
                </ng-container>
                <ng-template #placeholderAvatar>
                  <button
                    [ngClass]="{
                      'custom-filter': partita.numGiocatoriAttuali == 4
                    }"
                    class="btn btn-success rounded-circle position-relative btn-floating shadow-0 disabled"
                    style="width: 50px; height: 50px"
                  >
                    <img
                      src="https://upload.wikimedia.org/wikipedia/commons/archive/3/36/20120517134445%21Tennis_ball_3.svg"
                      alt="Placeholder Avatar"
                      class="w-100 h-100 rounded-circle img-fluid"
                      style="object-fit: cover"
                    />
                  </button>
                  <div
                    class="mt-2 text-center text-secondary avatar-text nome h6"
                  >
                    {{
                      partita.numGiocatoriAttuali === partita.numMaxGiocatori
                        ? "Bloccato"
                        : "Mancante"
                    }}
                  </div>
                </ng-template>
              </div>
            </div>
            <div class="d-flex justify-content-center gap-1 gap-md-3 mt-3">
              <button
                *ngIf="partita.utentiPrenotati.length == 4"
                style="width: 220px"
                [disabled]="!OraPassata(partita)"
                [ngClass]="{
                  'disabled btn-large ': partita.giocatoriVincenti.length == 2
                }"
                class="btn btn-primary btn-sm text-success shadow-none custom-button"
                (click)="apriModaleRisultato2(partita)"
              >
                {{
                  partita.giocatoriVincenti.length < 2
                    ? "Registra risultato"
                    : "Risultato inviato"
                }}
              </button>
              <button
                *ngIf="partita.utentiPrenotati.length < 4"
                style="width: 250px"
                class="btn btn-secondary btn-sm text-success shadow-none custom-button disabled"
              >
                Risultato Non disponibile
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
